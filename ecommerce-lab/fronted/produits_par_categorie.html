<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Produits – {{ categorie.nom }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="container my-4">

  <h2 class="text-center">🛍️ Produits de la catégorie <strong>{{ categorie.nom }}</strong></h2>
  <p class="text-end text-muted">Total : {{ produits.total }} produits</p>

  <div class="text-start mb-3">
    <a href="{{ url_for('categorie.accueil') }}" class="btn btn-outline-secondary">🏠 Retour à l’accueil</a>
  </div>

  <div id="loader" style="display:none;" class="text-center my-4">
    <div class="spinner-border text-pink" role="status"></div>
    <p class="text-muted mt-2">Chargement en cours…</p>
  </div>

  <div class="row table-fade">
    {% for produit in produits.items %}
      <div class="col-md-4 mb-4">
        <div class="produit-card text-center p-3 border rounded shadow-sm">
          <a href="{{ url_for('produit.afficher_produit_carrousel', id=produit.id) }}">
            <img src="{{ produit.images[0].url if produit.images else '' }}" alt="{{ produit.nom }}"
                 class="img-fluid" style="height: 200px; object-fit: cover;">
          </a>
          <h4 class="mt-3">{{ produit.nom }}</h4>
          <p class="text-muted">{{ produit.prix }} MAD</p>
          <a href="{{ url_for('produit.afficher_produit_carrousel', id=produit.id) }}" 
             class="btn btn-outline-primary btn-sm">👀 Voir le produit</a>
          <button class="btn btn-success btn-sm mt-2" onclick="ajouterAuPanier('{{ produit.id }}')">🛒 Ajouter au panier</button>
        </div>
      </div>
    {% else %}
      <div class="col-12 text-center">
        <p class="text-muted">Aucun produit disponible dans cette catégorie pour le moment.</p>
      </div>
    {% endfor %}
  </div>

  <nav aria-label="Pagination">
    <ul class="pagination justify-content-center">
      {% if produits.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('categorie.produits_par_categorie', id=categorie.id, page=produits.prev_num) }}">← Précédent</a>
        </li>
      {% endif %}
      <li class="page-item disabled">
        <span class="page-link">Page {{ produits.page }} / {{ produits.pages }}</span>
      </li>
      {% if produits.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('categorie.produits_par_categorie', id=categorie.id, page=produits.next_num) }}">Suivant →</a>
        </li>
      {% endif %}
    </ul>
  </nav>

  <script>
    document.querySelectorAll('.page-link').forEach(link => {
      link.addEventListener('click', () => {
        document.getElementById('loader').style.display = 'block';
      });
    });

    function ajouterAuPanier(produitId) {
      fetch("{{ url_for('panier.ajouter_au_panier_ajax') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `produit_id=${produitId}&csrf_token={{ csrf_token() }}`
      })
      .then(response => response.json())
      .then(data => {
        afficherMessage(data.message);
      });
    }

    function afficherMessage(msg) {
      const flash = document.createElement("div");
      flash.className = "alert alert-info position-fixed top-0 end-0 m-3";
      flash.textContent = msg;
      document.body.appendChild(flash);
      setTimeout(() => flash.remove(), 3000);
    }
  </script>

</body>
</html>
